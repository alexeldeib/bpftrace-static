name: build images

on:
    push:
        branches:
            - master
    schedule:
        - cron: "0 4 * * *"

env:
    DOCKER_USER: ${{ secrets.DOCKER_USER }}
    DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
    REPO: docker.io/alexeldeib
    IMG_PREFIX: bpftrace-bin-

jobs:
    bpftrace:
        runs-on: ubuntu-16.04
        strategy:
          matrix:
            llvm: [8, 9]
            distro: [xenial, bionic]
        steps:
            - uses: actions/checkout@master
            - name: build image
              run: |
                set -eux
                docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
                TAG=$(date -Ihours | tr :+ -)
                echo "TAG: ${TAG}"
                docker build --build-arg distro=${{ matrix.distro }} --build-arg LLVM_VERSION=${{ matrix.llvm }} -t  ${REPO}/${IMG_PREFIX}${{ matrix.distro }}-llvm-${{ matrix.llvm }}:${TAG} .
                docker push ${REPO}/${IMG_PREFIX}${{ matrix.distro }}-llvm-${{ matrix.llvm }}:${TAG}
